<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Tutor - Your Personal Learning Assistant</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 20px 30px;
            margin-bottom: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            display: flex;
            align-items: center;
            font-size: 24px;
            font-weight: bold;
            color: #667eea;
        }

        .logo i {
            margin-right: 10px;
            font-size: 30px;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(45deg, #667eea, #764ba2);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary {
            background: rgba(255, 255, 255, 0.2);
            color: #333;
            border: 1px solid rgba(0, 0, 0, 0.1);
        }

        .btn-secondary:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .main-content {
            display: flex;
            gap: 20px;
            flex: 1;
        }

        .sidebar {
            width: 300px;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            height: fit-content;
        }

        .sidebar h3 {
            color: #667eea;
            margin-bottom: 20px;
            font-size: 18px;
        }

        .subject-btn {
            width: 100%;
            text-align: left;
            margin-bottom: 10px;
            padding: 15px;
            background: rgba(102, 126, 234, 0.1);
            border: 1px solid rgba(102, 126, 234, 0.2);
            border-radius: 10px;
            transition: all 0.3s ease;
        }

        .subject-btn:hover, .subject-btn.active {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            transform: translateX(5px);
        }

        .chat-area {
            flex: 1;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .chat-header {
            padding: 20px 25px;
            border-bottom: 1px solid rgba(0, 0, 0, 0.1);
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
        }

        .chat-messages {
            flex: 1;
            padding: 25px;
            overflow-y: auto;
            max-height: 500px;
            background: linear-gradient(to bottom, rgba(255, 255, 255, 0.05), rgba(255, 255, 255, 0.1));
        }

        .message {
            margin-bottom: 20px;
            display: flex;
            align-items: flex-start;
            gap: 12px;
        }

        .message.user {
            flex-direction: row-reverse;
        }

        .message-avatar {
            width: 35px;
            height: 35px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            font-weight: bold;
            flex-shrink: 0;
        }

        .message.user .message-avatar {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
        }

        .message.assistant .message-avatar {
            background: linear-gradient(45deg, #ff6b6b, #ffa726);
            color: white;
        }

        .message-content {
            background: rgba(255, 255, 255, 0.9);
            padding: 15px 20px;
            border-radius: 18px;
            max-width: 80%;
            line-height: 1.6;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .message.user .message-content {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
        }

        .chat-input-area {
            padding: 20px 25px;
            border-top: 1px solid rgba(0, 0, 0, 0.1);
            background: rgba(255, 255, 255, 0.5);
        }

        .input-container {
            display: flex;
            gap: 15px;
            align-items: flex-end;
        }

        .chat-input {
            flex: 1;
            padding: 15px 20px;
            border: 2px solid rgba(102, 126, 234, 0.2);
            border-radius: 25px;
            font-size: 16px;
            resize: none;
            min-height: 50px;
            max-height: 120px;
            background: rgba(255, 255, 255, 0.9);
            transition: all 0.3s ease;
        }

        .chat-input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .send-btn {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            transition: all 0.3s ease;
        }

        .send-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 5px 20px rgba(102, 126, 234, 0.4);
        }

        .send-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .auth-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(5px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .auth-form {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            padding: 40px;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            width: 400px;
            max-width: 90vw;
        }

        .auth-form h2 {
            text-align: center;
            color: #667eea;
            margin-bottom: 30px;
            font-size: 28px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #333;
            font-weight: 600;
        }

        .form-group input {
            width: 100%;
            padding: 15px;
            border: 2px solid rgba(102, 126, 234, 0.2);
            border-radius: 10px;
            font-size: 16px;
            transition: all 0.3s ease;
        }

        .form-group input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .auth-buttons {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-top: 30px;
        }

        .switch-auth {
            text-align: center;
            margin-top: 20px;
            color: #666;
        }

        .switch-auth a {
            color: #667eea;
            text-decoration: none;
            font-weight: 600;
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .hidden {
            display: none !important;
        }

        .typing-indicator {
            display: flex;
            align-items: center;
            gap: 5px;
            padding: 10px 20px;
            background: rgba(255, 255, 255, 0.9);
            border-radius: 18px;
            margin-bottom: 20px;
        }

        .typing-dots {
            display: flex;
            gap: 4px;
        }

        .typing-dots span {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #667eea;
            animation: typing 1.4s infinite ease-in-out both;
        }

        .typing-dots span:nth-child(1) { animation-delay: -0.32s; }
        .typing-dots span:nth-child(2) { animation-delay: -0.16s; }

        @keyframes typing {
            0%, 80%, 100% { transform: scale(0.8); opacity: 0.5; }
            40% { transform: scale(1); opacity: 1; }
        }

        @media (max-width: 768px) {
            .main-content {
                flex-direction: column;
            }
            
            .sidebar {
                width: 100%;
                order: 2;
            }
            
            .chat-area {
                order: 1;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header class="header">
            <div class="logo">
                <i class="fas fa-graduation-cap"></i>
                AI Tutor
            </div>
            <div class="user-info hidden" id="userInfo">
                <div class="user-avatar" id="userAvatar"></div>
                <span id="userName"></span>
                <button class="btn btn-secondary" onclick="logout()">
                    <i class="fas fa-sign-out-alt"></i>
                    Logout
                </button>
            </div>
            <div id="authButtons">
                <button class="btn btn-primary" onclick="showAuthModal('login')">Login</button>
                <button class="btn btn-secondary" onclick="showAuthModal('signup')">Sign Up</button>
            </div>
        </header>

        <div class="main-content">
            <aside class="sidebar">
                <h3><i class="fas fa-book"></i> Subjects</h3>
                <button class="btn subject-btn active" onclick="selectSubject('general')">
                    <i class="fas fa-comments"></i> General Help
                </button>
                <button class="btn subject-btn" onclick="selectSubject('math')">
                    <i class="fas fa-calculator"></i> Mathematics
                </button>
                <button class="btn subject-btn" onclick="selectSubject('science')">
                    <i class="fas fa-atom"></i> Science
                </button>
                <button class="btn subject-btn" onclick="selectSubject('english')">
                    <i class="fas fa-book-open"></i> English
                </button>
                <button class="btn subject-btn" onclick="selectSubject('history')">
                    <i class="fas fa-landmark"></i> History
                </button>
                <button class="btn subject-btn" onclick="selectSubject('programming')">
                    <i class="fas fa-code"></i> Programming
                </button>
            </aside>

            <main class="chat-area">
                <div class="chat-header">
                    <h2 id="currentSubject">
                        <i class="fas fa-comments"></i> General Help
                    </h2>
                    <p>Ask me anything and I'll help you learn step by step!</p>
                </div>
                
                <div class="chat-messages" id="chatMessages">
                    <div class="message assistant">
                        <div class="message-avatar">AI</div>
                        <div class="message-content">
                            Hello! I'm your AI tutor. I'm here to help you learn and understand any topic you're curious about. Feel free to ask me questions, request explanations, or seek help with homework. What would you like to learn today?
                        </div>
                    </div>
                </div>

                <div class="chat-input-area">
                    <div class="input-container">
                        <textarea 
                            id="chatInput" 
                            class="chat-input" 
                            placeholder="Ask me anything... e.g., 'Explain photosynthesis' or 'Help me solve this math problem'"
                            rows="1"
                        ></textarea>
                        <button id="sendBtn" class="send-btn" onclick="sendMessage()">
                            <i class="fas fa-paper-plane"></i>
                        </button>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- Auth Modal -->
    <div id="authModal" class="auth-modal hidden">
        <div class="auth-form">
            <h2 id="authTitle">Welcome Back</h2>
            <form id="authForm">
                <div class="form-group">
                    <label for="email">Email</label>
                    <input type="email" id="email" required>
                </div>
                <div class="form-group">
                    <label for="password">Password</label>
                    <input type="password" id="password" required>
                </div>
                <div class="form-group hidden" id="confirmPasswordGroup">
                    <label for="confirmPassword">Confirm Password</label>
                    <input type="password" id="confirmPassword">
                </div>
                <div class="auth-buttons">
                    <button type="submit" class="btn btn-primary" id="authSubmitBtn">
                        Sign In
                    </button>
                </div>
            </form>
            <div class="switch-auth">
                <span id="authSwitchText">Don't have an account?</span>
                <a href="#" id="authSwitchLink" onclick="toggleAuthMode()">Sign up</a>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/9.23.0/firebase-app-compat.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/9.23.0/firebase-auth-compat.min.js"></script>

    <script>
        // ✅ FIREBASE CONFIGURED: Your Vidyora AI Project
        const firebaseConfig = {
            apiKey: "AIzaSyAyFhDG_biaRbUGenWjF3MUB2UeCkSLFWs",
            authDomain: "vidyora-ai.firebaseapp.com",
            projectId: "vidyora-ai",
            storageBucket: "vidyora-ai.firebasestorage.app",
            messagingSenderId: "56554502831",
            appId: "1:56554502831:web:a2c266bec3b35b9ae8b25a"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();

        // Global variables
        let currentUser = null;
        let currentSubject = 'general';
        let isAuthMode = 'login';
        let chatHistory = [];

        // ✅ CONFIGURED: Multiple API Options for Maximum Reliability
        
        // Try these in order - some may work better than others
        const API_CONFIGS = [
            // Option 1: Hugging Face (Free)
            {
                name: 'Hugging Face',
                provider: 'huggingface',
                url: "https://api-inference.huggingface.co/models/microsoft/DialoGPT-medium",
                key: "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"
            },
            // Option 2: Alternative HF Model (Sometimes more stable)
            {
                name: 'Hugging Face GPT2',
                provider: 'huggingface_alt',
                url: "https://api-inference.huggingface.co/models/gpt2",
                key: "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"
            },
            // Option 3: Local Backup (Always works)
            {
                name: 'Educational Responses',
                provider: 'local',
                url: null,
                key: null
            }
        ];

        let currentAPIIndex = 0;

        // Option 2: OpenAI (Uncomment and replace key to use)
        /*
        const API_CONFIG = {
            provider: 'openai',
            url: "https://api.openai.com/v1/chat/completions",
            key: "REPLACE_WITH_YOUR_OPENAI_KEY", // ⚠️ Replace with your OpenAI key
            model: "gpt-3.5-turbo"
        };
        */

        // 🚨 IMPORTANT: You MUST replace the key above with your real token!

        // Initialize app
        document.addEventListener('DOMContentLoaded', function() {
            setupEventListeners();
            checkAuthState();
        });

        // Auth state observer
        auth.onAuthStateChanged((user) => {
            if (user) {
                currentUser = user;
                showUserInterface();
            } else {
                currentUser = null;
                hideUserInterface();
            }
        });

        function setupEventListeners() {
            // Chat input events
            document.getElementById('chatInput').addEventListener('keypress', function(e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendMessage();
                }
            });

            // Auto-resize textarea
            document.getElementById('chatInput').addEventListener('input', function() {
                this.style.height = 'auto';
                this.style.height = (this.scrollHeight) + 'px';
            });

            // Auth form submission
            document.getElementById('authForm').addEventListener('submit', handleAuth);
        }

        function checkAuthState() {
            // Check if user is logged in on page load
            const user = auth.currentUser;
            if (user) {
                showUserInterface();
            }
        }

        function showUserInterface() {
            document.getElementById('authButtons').classList.add('hidden');
            document.getElementById('userInfo').classList.remove('hidden');
            document.getElementById('userName').textContent = currentUser.email.split('@')[0];
            document.getElementById('userAvatar').textContent = currentUser.email[0].toUpperCase();
            document.getElementById('authModal').classList.add('hidden');
        }

        function hideUserInterface() {
            document.getElementById('authButtons').classList.remove('hidden');
            document.getElementById('userInfo').classList.add('hidden');
        }

        function showAuthModal(mode) {
            isAuthMode = mode;
            const modal = document.getElementById('authModal');
            const title = document.getElementById('authTitle');
            const submitBtn = document.getElementById('authSubmitBtn');
            const confirmGroup = document.getElementById('confirmPasswordGroup');
            const switchText = document.getElementById('authSwitchText');
            const switchLink = document.getElementById('authSwitchLink');

            if (mode === 'login') {
                title.textContent = 'Welcome Back';
                submitBtn.innerHTML = '<i class="fas fa-sign-in-alt"></i> Sign In';
                confirmGroup.classList.add('hidden');
                switchText.textContent = "Don't have an account?";
                switchLink.textContent = 'Sign up';
            } else {
                title.textContent = 'Create Account';
                submitBtn.innerHTML = '<i class="fas fa-user-plus"></i> Sign Up';
                confirmGroup.classList.remove('hidden');
                switchText.textContent = 'Already have an account?';
                switchLink.textContent = 'Sign in';
            }

            modal.classList.remove('hidden');
        }

        function toggleAuthMode() {
            isAuthMode = isAuthMode === 'login' ? 'signup' : 'login';
            showAuthModal(isAuthMode);
        }

        async function handleAuth(e) {
            e.preventDefault();
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            const submitBtn = document.getElementById('authSubmitBtn');

            // Show loading
            submitBtn.innerHTML = '<div class="loading"></div>';
            submitBtn.disabled = true;

            try {
                if (isAuthMode === 'login') {
                    await auth.signInWithEmailAndPassword(email, password);
                } else {
                    if (password !== confirmPassword) {
                        throw new Error('Passwords do not match');
                    }
                    await auth.createUserWithEmailAndPassword(email, password);
                }
            } catch (error) {
                alert(error.message);
                // Reset button
                const icon = isAuthMode === 'login' ? 'sign-in-alt' : 'user-plus';
                const text = isAuthMode === 'login' ? 'Sign In' : 'Sign Up';
                submitBtn.innerHTML = `<i class="fas fa-${icon}"></i> ${text}`;
                submitBtn.disabled = false;
            }
        }

        function logout() {
            auth.signOut();
            chatHistory = [];
            clearChat();
        }

        function selectSubject(subject) {
            currentSubject = subject;
            
            // Update active button
            document.querySelectorAll('.subject-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');

            // Update header
            const subjectNames = {
                'general': { name: 'General Help', icon: 'comments' },
                'math': { name: 'Mathematics', icon: 'calculator' },
                'science': { name: 'Science', icon: 'atom' },
                'english': { name: 'English', icon: 'book-open' },
                'history': { name: 'History', icon: 'landmark' },
                'programming': { name: 'Programming', icon: 'code' }
            };

            const subjectInfo = subjectNames[subject];
            document.getElementById('currentSubject').innerHTML = 
                `<i class="fas fa-${subjectInfo.icon}"></i> ${subjectInfo.name}`;

            // Clear chat and show welcome message for new subject
            clearChat();
            addMessage('assistant', `Great! I'm now ready to help you with ${subjectInfo.name}. What would you like to learn or practice?`);
        }

        function clearChat() {
            const messagesContainer = document.getElementById('chatMessages');
            messagesContainer.innerHTML = '';
            chatHistory = [];
        }

        async function sendMessage() {
            const input = document.getElementById('chatInput');
            const message = input.value.trim();
            
            if (!message || !currentUser) return;

            // Add user message
            addMessage('user', message);
            input.value = '';
            input.style.height = 'auto';

            // Show typing indicator
            showTypingIndicator();

            // Disable send button
            const sendBtn = document.getElementById('sendBtn');
            sendBtn.disabled = true;

            try {
                const response = await getAIResponse(message);
                hideTypingIndicator();
                addMessage('assistant', response);
            } catch (error) {
                hideTypingIndicator();
                addMessage('assistant', "I'm sorry, I encountered an error. Please try again later.");
                console.error('AI API Error:', error);
            }

            // Re-enable send button
            sendBtn.disabled = false;
        }

        function addMessage(sender, content) {
            const messagesContainer = document.getElementById('chatMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${sender}`;

            const avatar = document.createElement('div');
            avatar.className = 'message-avatar';
            avatar.textContent = sender === 'user' ? (currentUser?.email[0].toUpperCase() || 'U') : 'AI';

            const messageContent = document.createElement('div');
            messageContent.className = 'message-content';
            messageContent.textContent = content;

            messageDiv.appendChild(avatar);
            messageDiv.appendChild(messageContent);
            messagesContainer.appendChild(messageDiv);

            // Scroll to bottom
            messagesContainer.scrollTop = messagesContainer.scrollHeight;

            // Store in chat history
            chatHistory.push({ sender, content, timestamp: new Date() });
        }

        function showTypingIndicator() {
            const messagesContainer = document.getElementById('chatMessages');
            const typingDiv = document.createElement('div');
            typingDiv.className = 'message assistant typing-indicator';
            typingDiv.id = 'typingIndicator';

            const avatar = document.createElement('div');
            avatar.className = 'message-avatar';
            avatar.textContent = 'AI';

            const dotsContainer = document.createElement('div');
            dotsContainer.className = 'typing-dots';
            
            for (let i = 0; i < 3; i++) {
                const dot = document.createElement('span');
                dotsContainer.appendChild(dot);
            }

            typingDiv.appendChild(avatar);
            typingDiv.appendChild(dotsContainer);
            messagesContainer.appendChild(typingDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        function hideTypingIndicator() {
            const indicator = document.getElementById('typingIndicator');
            if (indicator) {
                indicator.remove();
            }
        }

        async function getAIResponse(userMessage) {
            // Create educational context based on subject
            const subjectContexts = {
                'general': "You are a helpful tutor. Provide clear, educational explanations.",
                'math': "You are a mathematics tutor. Break down problems step by step and show your work.",
                'science': "You are a science tutor. Explain concepts clearly with examples and real-world applications.",
                'english': "You are an English tutor. Help with grammar, writing, literature, and reading comprehension.",
                'history': "You are a history tutor. Provide context, dates, and explain cause-and-effect relationships.",
                'programming': "You are a programming tutor. Explain code concepts clearly and provide practical examples."
            };

            const context = subjectContexts[currentSubject] || subjectContexts['general'];
            const prompt = `${context}\n\nStudent question: ${userMessage}\n\nProvide a helpful, educational response:`;

            // Using a simple educational response system (replace with actual LLM API)
            return await callLLMAPI(prompt);
        }

        async function callLLMAPI(prompt) {
            // Try multiple APIs in order until one works
            for (let i = currentAPIIndex; i < API_CONFIGS.length; i++) {
                const config = API_CONFIGS[i];
                
                try {
                    console.log(`Trying ${config.name}...`);
                    
                    if (config.provider === 'local') {
                        // Always working local educational responses
                        return getEducationalResponse(prompt);
                    }
                    
                    let response;
                    
                    if (config.provider === 'huggingface' || config.provider === 'huggingface_alt') {
                        response = await fetch(config.url, {
                            method: 'POST',
                            headers: {
                                'Authorization': `Bearer ${config.key}`,
                                'Content-Type': 'application/json',
                                'User-Agent': 'AI-Tutor/1.0'
                            },
                            body: JSON.stringify({
                                inputs: prompt,
                                parameters: {
                                    max_new_tokens: 100,
                                    temperature: 0.8,
                                    do_sample: true,
                                    return_full_text: false
                                },
                                options: {
                                    wait_for_model: true,
                                    use_cache: false
                                }
                            })
                        });
                    }
                    
                    if (!response.ok) {
                        const errorText = await response.text();
                        throw new Error(`${config.name} API Error: ${response.status} - ${errorText}`);
                    }
                    
                    const data = await response.json();
                    let result;
                    
                    if (config.provider === 'huggingface' || config.provider === 'huggingface_alt') {
                        result = data[0]?.generated_text || data.generated_text;
                        
                        // Clean up the response
                        if (result) {
                            result = result.replace(prompt, '').trim();
                            if (result.length > 0) {
                                currentAPIIndex = i; // Remember working API
                                return result;
                            }
                        }
                    }
                    
                } catch (error) {
                    console.warn(`${config.name} failed:`, error.message);
                    
                    // If this was the last API, show detailed error
                    if (i === API_CONFIGS.length - 1) {
                        return getEducationalResponse(prompt);
                    }
                    
                    // Try next API
                    continue;
                }
            }
            
            // Fallback to educational responses
            return getEducationalResponse(prompt);
        }

        function getEducationalResponse(prompt) {
            const responses = {
                math: [
                    "Let me help you with this math problem! To solve this, we need to identify what type of problem it is and apply the right mathematical principles. Can you tell me more about what specific part you're struggling with?",
                    "Mathematics is all about patterns and logical thinking. For this type of problem, let's break it down into smaller, manageable steps. What information do we have, and what are we trying to find?",
                    "Great math question! The key to solving this is understanding the underlying concept first. Let me walk you through the approach step by step."
                ],
                science: [
                    "That's a fascinating scientific concept! Science is all about understanding how things work in the natural world. Let me explain this in a way that connects to real-life examples you can observe.",
                    "Excellent science question! The scientific method helps us understand cause and effect. For this topic, let's start with the basic principles and build up to the more complex ideas.",
                    "Science is everywhere around us! This concept relates to many things you see in daily life. Let me explain how this works and why it's important."
                ],
                english: [
                    "Language and literature are powerful tools for communication and expression. For this English concept, let's explore how it helps us communicate more effectively and understand different perspectives.",
                    "Great question about English! Whether it's grammar, writing, or literature, the key is understanding how language works to convey meaning. Let me break this down for you.",
                    "English skills are essential for clear communication. This concept will help you express your ideas more effectively, whether in writing or speaking."
                ],
                history: [
                    "History helps us understand how we got to where we are today. This historical event/concept is important because it shaped the world we live in. Let me explain the context and significance.",
                    "Understanding history means understanding cause and effect over time. For this topic, let's look at what led up to it, what happened, and what the consequences were.",
                    "History is full of fascinating stories and important lessons. This particular topic shows us how people in the past dealt with challenges and how their decisions affected the future."
                ],
                programming: [
                    "Programming is like solving puzzles with logic! For this coding concept, let's start with the basics and build up to more complex ideas. Understanding the 'why' is just as important as the 'how'.",
                    "Great programming question! Coding is all about breaking down complex problems into smaller, manageable pieces. Let me show you the approach and explain the reasoning behind it.",
                    "Programming languages are tools for expressing ideas and solving problems. This concept is fundamental to many areas of computer science. Let's explore it together!"
                ]
            };

            const subjectResponses = responses[currentSubject] || [
                "That's a wonderful question! Learning is a journey of discovery, and I'm here to guide you through it. Let me help you understand this concept in a clear and engaging way.",
                "I love helping students learn! This topic has some really interesting aspects. Let me break it down in a way that makes sense and connects to things you already know.",
                "Excellent question! The best way to learn is by asking questions and exploring ideas together. Let me share what I know about this topic in a helpful way."
            ];

            const randomResponse = subjectResponses[Math.floor(Math.random() * subjectResponses.length)];
            
            // Add specific educational content based on common topics
            const commonTopics = {
                'photosynthesis': 'Photosynthesis is how plants make their own food using sunlight, water, and carbon dioxide. The process happens in the chloroplasts and produces glucose and oxygen.',
                'quadratic': 'A quadratic equation has the form ax² + bx + c = 0. To solve it, you can use factoring, completing the square, or the quadratic formula: x = (-b ± √(b²-4ac)) / 2a.',
                'world war': 'World War I was caused by a complex web of alliances, nationalism, imperialism, and militarism. The assassination of Archduke Franz Ferdinand was the immediate trigger.',
                'essay': 'A good essay has three main parts: introduction (with thesis), body paragraphs (with evidence), and conclusion (that ties everything together).'
            };

            // Check if the prompt contains common educational topics
            const lowerPrompt = prompt.toLowerCase();
            for (const [topic, explanation] of Object.entries(commonTopics)) {
                if (lowerPrompt.includes(topic)) {
                    return `${randomResponse}\n\n${explanation}\n\nWould you like me to explain any part of this in more detail?`;
                }
            }

            return randomResponse + "\n\nCould you provide more details about what specific aspect you'd like to learn about?";
        }

        // Close modal when clicking outside
        document.getElementById('authModal').addEventListener('click', function(e) {
            if (e.target === this) {
                this.classList.add('hidden');
            }
        });

        // Prevent form submission on Enter in password fields
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Enter' && e.target.type === 'password') {
                e.preventDefault();
                document.getElementById('authForm').dispatchEvent(new Event('submit'));
            }
        });

        // Initialize with welcome message
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(() => {
                if (!currentUser) {
                    addMessage('assistant', 'Welcome to AI Tutor! Please log in or sign up to start your personalized learning journey.');
                }
            }, 500);
        });

        // Auto-save chat history to localStorage (if user is logged in)
        function saveChatHistory() {
            if (currentUser && chatHistory.length > 0) {
                const key = `chat_${currentUser.uid}_${currentSubject}`;
                localStorage.setItem(key, JSON.stringify(chatHistory.slice(-20))); // Keep last 20 messages
            }
        }

        // Load chat history from localStorage
        function loadChatHistory() {
            if (currentUser) {
                const key = `chat_${currentUser.uid}_${currentSubject}`;
                const saved = localStorage.getItem(key);
                if (saved) {
                    const history = JSON.parse(saved);
                    chatHistory = history;
                    // Display last few messages
                    clearChat();
                    history.slice(-5).forEach(msg => {
                        addMessage(msg.sender, msg.content);
                    });
                }
            }
        }

        // Save chat history when new message is added
        const originalAddMessage = addMessage;
        addMessage = function(sender, content) {
            originalAddMessage(sender, content);
            if (sender !== 'system') {
                saveChatHistory();
            }
        };

        // Load history when subject changes or user logs in
        const originalSelectSubject = selectSubject;
        selectSubject = function(subject) {
            if (currentUser) {
                saveChatHistory(); // Save current subject history
            }
            originalSelectSubject(subject);
            if (currentUser) {
                setTimeout(loadChatHistory, 100); // Load new subject history
            }
        };

        const originalShowUserInterface = showUserInterface;
        showUserInterface = function() {
            originalShowUserInterface();
            setTimeout(loadChatHistory, 200);
        };
    </script>
</body>
    </html>
